<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="system-api-mock.html">

<dom-module id="system-api">
    <template>
        <style>
        :host {
            display: none;
        }
        </style>

        <system-api-mock id="mock" no-warning></system-api-mock>
    </template>
    <script>
    Polymer({
        is: 'system-api',

        properties: {
            mock: {
                type: Boolean,
                value: false,
                observer: '_mockChanged'
            }
        },

        identifyDisplays: function() {
            if (this.mock) {
                return;
            }

            this.getDisplays().forEach(this._identify.bind(this));
        },

        getPrimaryDisplay: function() {
            if (this.mock) {
                return this.$.mock.getDisplays()[0];
            }

            return this.__electron.screen.getPrimaryDisplay();
        },

        getDisplays: function() {
            const primary = this.getPrimaryDisplay();
            return (this.mock ? this.$.mock.getDisplays() : this.__electron.screen.getAllDisplays()).map(function(display, idx) {
                display.name = (function(idx) {
                    switch (idx) {
                        case 0:
                            return 'First';
                        case 1:
                            return 'Second';
                        case 2:
                            return 'Third';
                        default:
                            return (idx + 1) + 'th';
                    }
                })(idx) + ' display';

                if (display.id === primary.id) {
                    display.name += ' (primary)';
                }

                return display;
            });
        },

        _identify: function(display) {
            let identifierWindow = new(this.__electron.remote.BrowserWindow)((os => {
                switch (os) {
                    case 'Linux':
                        return {
                            x: display.bounds.x + 1,
                            y: display.bounds.y + 1,
                            width: display.bounds.width,
                            height: display.bounds.height,
                            parent: this.__electron.remote.getCurrentWindow(),
                            modal: true,
                            frame: false,
                            transparent: true,
                            alwaysOnTop: true,
                            fullscreen: true,
                            resizable: false
                        };
                    case 'Windows_NT':
                    default:
                        return {
                            x: display.bounds.x + display.bounds.width / 2,
                            y: display.bounds.y + display.bounds.width / 2,
                            parent: this.__electron.remote.getCurrentWindow(),
                            modal: true,
                            frame: false,
                            transparent: true,
                            alwaysOnTop: true,
                            fullscreen: true,
                            resizable: false,
                            minimizable: false,
                            show: false
                        };
                }
            })(this.__os.type()));

            identifierWindow.loadURL(this.__url.format({
                pathname: this.__path.join(__dirname, 'index.display.html'),
                protocol: 'file:',
                slashes: true,
                query: {
                    name: display.name
                }
            }));

            identifierWindow.on('close', function() {
                identifierWindow = null;
            });

            function closeOnMouseMove() {
                const screen = this.__electron.screen;
                this.async(function(orig) {
                    const cur = screen.getCursorScreenPoint();
                    if (cur.x != orig.x || cur.y != orig.y) {
                        identifierWindow && identifierWindow.close();
                        identifierWindow = null;
                    } else {
                        this.async(arguments.callee.bind(this, screen.getCursorScreenPoint()), 100);
                    }
                }.bind(this, screen.getCursorScreenPoint()), 100);
            }

            switch (this.__os.type()) {
                case 'Linux':
                    // on most Linux platforms, a modal window can't ever be hidden
                    this.async(closeOnMouseMove, 1000);
                    break;
                case 'Windows_NT':
                default:
                    // when possible, the window is hidden until rendered -- ready-to-show
                    identifierWindow.once('ready-to-show', () => {
                        identifierWindow.show();
                        identifierWindow.focus();
                        this.async(closeOnMouseMove, 1000);
                    });
            }
        },

        _mockChanged: function(mock) {
            if (mock) {
                console.log('Using a mocked system environment');
                ['os', 'electron', 'url', 'path'].forEach(module => delete this['__' + module]);
            } else {
                ['os', 'electron', 'url', 'path'].forEach(module => this['__' + module] = require(module));
            }
        }
    });
    </script>
</dom-module>
